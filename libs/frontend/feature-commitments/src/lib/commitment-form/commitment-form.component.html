<div class="page">
  <h1>{{ isEditMode ? 'Edit' : 'Add' }} Recurring Commitment</h1>

  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="form-row">
      <label class="checkbox">
        <input type="checkbox" formControlName="isShared" />
        Shared (applies to whole family)
      </label>
    </div>

    <div class="form-row">
      <label for="familyMemberId">Owner (required if not shared)</label>
      <select id="familyMemberId" formControlName="familyMemberId">
        <option value="">Select a member</option>
        @for (m of members(); track m.familyMemberId) {
        <option [value]="m.familyMemberId">{{ m.name }}</option>
        }
      </select>
      @if (members().length === 0) {
      <small class="hint warning">
        ⚠️ No family members found.
        <a routerLink="/family">Add family members first</a>.
      </small>
      }
    </div>

    <div class="form-row">
      <label for="title">Title *</label>
      <input id="title" type="text" formControlName="title" />
    </div>

    <div class="form-row">
      <label for="blockType">Type *</label>
      <select id="blockType" formControlName="blockType">
        <option value="WORK">WORK</option>
        <option value="ACTIVITY">ACTIVITY</option>
        <option value="MEAL">MEAL</option>
        <option value="OTHER">OTHER</option>
      </select>
    </div>

    <div class="schedule-section">
      <div class="section-header">
        <label>Schedule *</label>
      </div>

      @for (slot of daySlots; track slot.id; let i = $index) {
      <div class="day-slot">
        <div class="day-slot-controls">
          <div class="form-field">
            <label [for]="'day-' + i">Day</label>
            <select
              [id]="'day-' + i"
              [(ngModel)]="slot.dayOfWeek"
              [ngModelOptions]="{ standalone: true }"
            >
              <option [value]="1">Monday</option>
              <option [value]="2">Tuesday</option>
              <option [value]="3">Wednesday</option>
              <option [value]="4">Thursday</option>
              <option [value]="5">Friday</option>
              <option [value]="6">Saturday</option>
              <option [value]="7">Sunday</option>
            </select>
          </div>

          <div class="form-field">
            <label [for]="'start-' + i">Start</label>
            <input
              [id]="'start-' + i"
              type="time"
              step="60"
              [(ngModel)]="slot.startTime"
              [ngModelOptions]="{ standalone: true }"
            />
          </div>

          <div class="form-field">
            <label [for]="'end-' + i">End</label>
            <input
              [id]="'end-' + i"
              type="time"
              step="60"
              [(ngModel)]="slot.endTime"
              [ngModelOptions]="{ standalone: true }"
            />
          </div>

          @if (daySlots.length > 1) {
          <button
            type="button"
            class="btn-remove"
            (click)="removeDaySlot(i)"
            title="Remove this day"
          >
            ✕
          </button>
          }
        </div>
      </div>
      }

      <button
        type="button"
        class="btn-add-day"
        (click)="addDaySlot()"
        title="Add another day"
      >
        +
      </button>
    </div>

    <div class="actions">
      <button type="button" class="btn-secondary" (click)="onCancel()">
        Cancel
      </button>
      <button type="submit" class="btn-primary" [disabled]="form.invalid">
        {{ isEditMode ? 'Update' : 'Create' }}
      </button>
    </div>
  </form>
</div>
